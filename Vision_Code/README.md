# Dart

# 目录

- [Dart](#dart)
- [目录](#目录)
- [本次测试环境](#本次测试环境)
- [使用](#使用)
  - [编译](#编译)
  - [运行](#运行)
- [cmake 版本升级](#cmake-版本升级)
- [FlatBuffers](#flatbuffers)
  - [安装](#安装)
  - [头文件生成](#头文件生成)
- [OpenVINO](#openvino)
  - [安装](#安装-1)
  - [设备选择](#设备选择)
  - [cmake配置](#cmake配置)
- [常见问题](#常见问题)
  - [**liblz4** 版本错误](#liblz4-版本错误)
  - [Could not open file ../config/autogenerated\_flatbuffers/CaptureInformation.bfbs](#could-not-open-file-configautogenerated_flatbufferscaptureinformationbfbs)
  - [\["../bag/2025\_4\_4\_19\_39\_16.mcap"\] does not exit, try to create](#bag2025_4_4_19_39_16mcap-does-not-exit-try-to-create)
  - [\[GPU\] Can't get PERFORMANCE\_HINT property as no supported devices found or an error happened during devices query.](#gpu-cant-get-performance_hint-property-as-no-supported-devices-found-or-an-error-happened-during-devices-query)
  - [ioctl: Bad file descriptor](#ioctl-bad-file-descriptor)
  - [MV\_CC\_SetEnumValue fail for n\_ret = \[80000106\].](#mv_cc_setenumvalue-fail-for-n_ret--80000106)


# 本次测试环境

```bash
Linux LAPTOP-OUFSCOEG 5.15.167.4-microsoft-standard-WSL2 #1 SMP Tue Nov 5 00:21:55 UTC 2024 x86_64 x86_64 x86_64 GNU/Linux
Distributor ID:	Ubuntu
Description:	Ubuntu 22.04.5 LTS
Release:	22.04
Codename:	jammy
cmake version 4.0.0
flatc version 25.2.10
GLIBC version ldd (Ubuntu GLIBC 2.35-0ubuntu3.9) 2.35
gcc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0
g++ (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0
```

# 使用

`Vision_Code` 目录下

```bash
mkdir -p build && cd build
cmake ..
```

配置完成
```bash
root@LAPTOP-OUFSCOEG:/home/RM_feibiao/Vision_test/Vision_Code/build# cmake ..
-- The C compiler identification is GNU 11.4.0
-- The CXX compiler identification is GNU 11.4.0
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Check for working C compiler: /usr/bin/cc - skipped
-- Detecting C compile features
-- Detecting C compile features - done
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Check for working CXX compiler: /usr/bin/c++ - skipped
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- Found OpenCV: /usr (found version "4.5.4")
-- Configuring done (1.8s)
-- Generating done (0.0s)
-- Build files have been written to: /home/RM_feibiao/Vision_test/Vision_Code/build
```

## 编译

```bash
cmake --build . -j$(nproc)
```
## 运行

```bash
sudo ./Dart
```

# cmake 版本升级

在[https://github.com/Kitware/CMake](https://github.com/Kitware/CMake)查看版本 >= 3.25

```bash
wget https://github.com/Kitware/CMake/releases/download/v3.28.3/cmake-3.28.3-linux-x86_64.sh

sudo bash ./cmake-3.23.0-linux-x86_64.sh --skip-licence --prefix=/usr
```

```bash
# 安装过程中遇到：
# 选择1
Do you accept the license? [yn]: 
# 输入 y
 
# 选择2
By default the CMake will be installed in:
  "/usr/cmake-3.23.0-linux-x86_64"
Do you want to include the subdirectory cmake-3.23.0-linux-x86_64?
Saying no will install in: "/usr" [Yn]:
# 输入 n
```

验证 ```cmake --version```

# FlatBuffers
## 安装

[https://github.com/google/flatbuffers](https://github.com/google/flatbuffers)

```bash
git clone https://github.com/google/flatbuffers.git
cd flatbuffers
mkdir build && cd build
cmake .. -G "Unix Makefiles"
make -j $(nproc)
sudo make install
flatc --version # 验证
```

## 头文件生成

在 `config` 文件夹下

```bash
mkdir autogenerated_flatbuffers && cd autogenerated_flatbuffers
flatc --cpp ../flatbuffers/*.fbs
```

# OpenVINO

## 安装

[点击查看官方教程](https://docs.openvino.ai/2025/get-started/install-openvino/install-openvino-archive-linux.html)

我的安装:

> [!NOTE]
> 如果你的系统和本测试环境相差过大，建议还是去官方查看并下载合适的版本
>
> 经过测试，openvino版本不建议使用最新版，依赖更新比较麻烦，出现问题可以尝试旧版本

```bash
curl -L https://storage.openvinotoolkit.org/repositories/openvino/packages/2025.0/linux/openvino_toolkit_ubuntu24_2025.0.0.17942.1f68be9f594_x86_64.tgz --output openvino_2025.0.0.tgz
tar -xf openvino_2025.0.0.tgz
sudo mkdir /opt/intel
sudo mv openvino_toolkit_ubuntu24_2025.0.0.17942.1f68be9f594_x86_64 /opt/intel/openvino_2025.0.0
cd /opt/intel/openvino_2025.0.0
sudo -E ./install_dependencies/install_openvino_dependencies.sh
```

设置环境变量

```bash
source /opt/intel/openvino_2025.0.0/setupvars.sh
```

## 设备选择
`Vision_Code/config/json/detect.json` 文件第 5 行选择 `CPU` 或 `GPU`

```bash
{
  "path": {
    "xml": "../config/openvino/Katrin.xml",
    "bin": "../config/openvino/Katrin.bin",
    "device": "CPU"
  },
  "openvino": {
    "width": 640,
    "height": 384,
    "score_threshold": 0.5,
    "nms_threshold": 0.25
  }
}
```

对于 `GPU` 设备需自行安装相关驱动，可能的有：

```bash
cd opencl
wget https://github.com/intel/intel-graphics-compiler/releases/download/igc-1.0.14062.11/intel-igc-core_1.0.14062.11_amd64.deb
wget https://github.com/intel/intel-graphics-compiler/releases/download/igc-1.0.14062.11/intel-igc-opencl_1.0.14062.11_amd64.deb
wget https://github.com/intel/compute-runtime/releases/download/23.22.26516.18/intel-level-zero-gpu-dbgsym_1.3.26516.18_amd64.ddeb
wget https://github.com/intel/compute-runtime/releases/download/23.22.26516.18/intel-level-zero-gpu_1.3.26516.18_amd64.deb
wget https://github.com/intel/compute-runtime/releases/download/23.22.26516.18/intel-opencl-icd-dbgsym_23.22.26516.18_amd64.ddeb
wget https://github.com/intel/compute-runtime/releases/download/23.22.26516.18/intel-opencl-icd_23.22.26516.18_amd64.deb
wget https://github.com/intel/compute-runtime/releases/download/23.22.26516.18/libigdgmm12_22.3.0_amd64.deb
```

安装 `sudo dpkg -i *.deb`

## cmake配置

更新 `OpenVINO` 路径

`/Vision_Code/src/detect/CMakeLists.txt`

第 3 行
```bash
SET(OPENVINO_PATH "/opt/intel/openvino_2025.0.0/runtime/include")
```

第 16 行
```bash
target_link_libraries(${PROJECT_NAME} PUBLIC "/opt/intel/openvino_2025.0.0/runtime/lib/intel64/libopenvino.so")
```

# 常见问题

## **liblz4** 版本错误

```bash
No rule to make target '/usr/lib/x86_64-linux-gnu/liblz4.so.1.9.2', needed by 'Dart'.  Stop.
```

删除 `Vision_Code/src/capture/CMakeLists.txt` 第 15~20 的版本号指定

```bash
target_link_libraries(
        ${PROJECT_NAME} PRIVATE
        /usr/lib/x86_64-linux-gnu/liblz4.so
        /usr/lib/x86_64-linux-gnu/libzstd.so
        flatbuffers::flatbuffers
)
```

## Could not open file ../config/autogenerated_flatbuffers/CaptureInformation.bfbs

```bash
root@LAPTOP-OUFSCOEG:/home/RM_feibiao/Vision_test/Vision_Code/build# ./Dart
capture thread start.
["../bag/2025_4_4_19_39_16.mcap"] does not exit, try to create
terminate called after throwing an instance of 'std::runtime_error'
  what():  Could not open file ../config/autogenerated_flatbuffers/CaptureInformation.bfbs
Aborted (core dumped)
```

在 `build` 文件夹下，生成 `CaptureInformation.bfbs` 文件

```bash
flatc --binary --schema -o ../config/autogenerated_flatbuffers ../config/flatbuffers/CaptureInformation.fbs
```

## ["../bag/2025_4_4_19_39_16.mcap"] does not exit, try to create

这个是正常的，但要有 `bag` 文件夹，没有手动创建 `Vision_Code/bag`

```bash
mkdir bag
```

## [GPU] Can't get PERFORMANCE_HINT property as no supported devices found or an error happened during devices query.

```bash
terminate called after throwing an instance of 'ov::Exception'
  what():  Exception from src/inference/src/cpp/core.cpp:104:
Check '!m_device_map.empty()' failed at src/plugins/intel_gpu/src/plugin/plugin.cpp:419:
[GPU] Can't get PERFORMANCE_HINT property as no supported devices found or an error happened during devices query.
[GPU] Please check OpenVINO documentation for GPU drivers setup guide.
```

这个说明没有GPU设备，查看 **OpenVino** [设备选择](#设备选择)

## ioctl: Bad file descriptor

目前查到的原因是没有连接串口

## MV_CC_SetEnumValue fail for n_ret = [80000106].

类似输出有很多，查看 **`Vision_Code/src/sensors/inc/hikrobot/inc/MvErrorDefine.h`** 的宏定义，根据错误码解决问题

如当前 `80000106` 是因为 `this->setEnumValue("ADCBitDepth", 0);`